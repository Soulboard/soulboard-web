version: '3.8'

services:
  soul-orchestrator:
    build:
      context: ..
      dockerfile: soul-orchestrator/Dockerfile
    container_name: soul-orchestrator
    restart: unless-stopped
    environment:
      - RPC_URL=${RPC_URL:-https://api.devnet.solana.com}
      - WALLET_PATH=${WALLET_PATH:-/root/.config/solana/phantom.json}
      - THINGSPEAK_URL=${THINGSPEAK_URL:-https://api.thingspeak.com/channels/2890626/feeds.json?results=11}
      - LOCATION_PUBKEY=${LOCATION_PUBKEY}
      - DEVICE_IDX=${DEVICE_IDX}
      - DEVICE_AUTHORITY=${DEVICE_AUTHORITY}
      - ALLOW_REGISTER=${ALLOW_REGISTER:-true}
      - POLL_INTERVAL_MS=${POLL_INTERVAL_MS:-120000}
      - STATE_PATH=${STATE_PATH:-/data/oracle-state.json}
    volumes:
      # Mount wallet file if it exists locally
      - ${HOME}/.config/solana:/root/.config/solana:ro
      - ./oracle-state.json:/data/oracle-state.json
    network_mode: host

  soul-orchestrator-device0:
    build:
      context: ..
      dockerfile: soul-orchestrator/Dockerfile
    container_name: soul-orchestrator-device0
    restart: unless-stopped
    env_file:
      - .env.device0
    environment:
      - STATE_PATH=/data/oracle-state-device0.json
    volumes:
      # Mount wallet file if it exists locally
      - ${HOME}/.config/solana:/root/.config/solana:ro
      - ./oracle-state-device0.json:/data/oracle-state-device0.json
    network_mode: host

  soul-orchestrator-device1:
    build:
      context: ..
      dockerfile: soul-orchestrator/Dockerfile
    container_name: soul-orchestrator-device1
    restart: unless-stopped
    env_file:
      - .env.device1
    environment:
      - STATE_PATH=/data/oracle-state-device1.json
    volumes:
      # Mount wallet file if it exists locally
      - ${HOME}/.config/solana:/root/.config/solana:ro
      - ./oracle-state-device1.json:/data/oracle-state-device1.json
    network_mode: host
    # Alternative network configuration if not using host mode:
    # ports:
    #   - "3000:3000"
    # networks:
    #   - soul-orchestrator-network

# networks:
#   soul-orchestrator-network:
#     driver: bridge 
