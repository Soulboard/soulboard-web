name: Foundry CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Run Foundry Tests
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🧪 Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: ⚙️ Install dependencies (optional)
        run: forge install

      - name: 🧱 Build contracts
        run: forge build

      - name: ✅ Run tests
        run: forge test -vvv

  deploy:
    name: Deploy Contracts to Sepolia
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🧪 Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: 🔐 Setup Secrets
        run: echo "RPC_URL=$SEPOLIA_RPC_URL" >> .env
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}

      - name: 🚀 Deploy Contracts
        run: |
          forge script script/DeployAllContracts.s.sol:DeployAllContracts \
            --rpc-url ${{ secrets.SEPOLIA_RPC_URL }} \
            --private-key ${{ secrets.PRIVATE_KEY }} \
            --broadcast \
            --verify \
            --etherscan-api-key dummy \
            --legacy
